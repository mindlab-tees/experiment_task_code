/* bcst_task.js */
// This is the main task file for Berg's Card Sorting Task (BCST) for jsPsych version 7, based on (Fox et al., 2013) 
// based on an example from https://github.com/vekteo/Card_sorting_jsPsych (which was for jsPsych version 6) and using their image assets
// coded by Chrisopher Wilson at the Wilson-Medimorec MIND Lab: www.theMINDlab.uk
// Comments generated by AI for clarity - let me know if there are any issues!
// It uses the configuration from bcst_config.js


function createBCSTTask(jsPsych) {

    // --- 1. SETUP VARIABLES ---
    var DECK_TYPE = BCST_CONFIG.deck_type; 
    var STREAK_THRESHOLD = BCST_CONFIG.streak_threshold;
    var IMG_FOLDER = BCST_CONFIG.img_folder;
    var ruleSequence = BCST_CONFIG.rule_sequence;
    
    // Internal State
    var currentRuleIndex = 0;
    var consecutiveCorrect = 0;
    var activeRule = ruleSequence[0];

    // --- 2. DECK GENERATION (Standard 64 cards) ---
    var colors = ['red', 'green', 'yellow', 'blue'];
    var shapes = ['triangle', 'star', 'diamond', 'circle'];
    var numbers = [1, 2, 3, 4];
    var deck = [];

    for (var c of colors) {
        for (var s of shapes) {
            for (var n of numbers) {
                deck.push({
                    color: c,
                    shape: s,
                    number: n,
                    image: s + '_' + c + '_' + n + '.png'
                });
            }
        }
    }

    if (DECK_TYPE === 'random') {
        deck = jsPsych.randomization.shuffle(deck);
    } 

    // --- 3. INSTRUCTIONS (NEW) ---
    var instructions = {
        type: jsPsychInstructions, // Assumes plugin-instructions.js is loaded
        pages: [
            // Page 1: Welcome
            '<h2> Task Instructions</h2>' +
            '<p>In this task, you will see a card at the top of the screen and four cards at the bottom.</p>' +
            '<p>Your task is to match the top card with one of the four bottom cards.</p>',
            
            // Page 2: The Rules & Image
            '<h2>How to Match</h2>' +
            '<p>You must determine the rule for matching (by Color, Shape, or Number).</p>' +
            '<p>We will not tell you the rule, but you will be told "Correct" or "Incorrect" after every choice.</p>' +
            '<div style="margin: 20px;">' +
            // Uses config path for the image
            '<img src="' + IMG_FOLDER + 'instruction.png" style="max-width:600px; width:100%; height:auto; border:1px solid #ccc;">' +
            '</div>',

            // Page 3: Rule Change Warning
            '<h2>Important!</h2>' +
            '<p>The matching rule may <strong>change</strong> during the task without warning.</p>' +
            '<p>If you suddenly start getting "Incorrect" feedback, try a different rule (e.g., switch from Color to Shape).</p>' +
            '<p>Click "Next" to begin.</p>'
        ],
        show_clickable_nav: true,
        button_label_next: "Next",
        button_label_previous: "Previous"
    };

    // --- 4. REFERENCE CARDS & TRIALS ---
    var referenceCards = [
        { color: 'red', shape: 'triangle', number: 1, img: 'triangle_red_1.png' },
        { color: 'green', shape: 'star', number: 2, img: 'star_green_2.png' },
        { color: 'yellow', shape: 'diamond', number: 3, img: 'diamond_yellow_3.png' },
        { color: 'blue', shape: 'circle', number: 4, img: 'circle_blue_4.png' }
    ];

    var choiceHTML = referenceCards.map(function(card) {
        return '<img src="' + IMG_FOLDER + card.img + '" style="width:100%; height:auto; display:block;">';
    });

    // The Sort Trial
    var sort_trial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
            var card = jsPsych.timelineVariable('image');
            return '<div style="margin-bottom: 20px;">' +
                   '<img src="' + IMG_FOLDER + card + '" style="width:150px; height:auto; border: 2px solid #333;">' +
                   '</div>';
        },
        choices: choiceHTML,
        prompt: "<p>Match the top card to one of the bottom cards.</p>",
        button_html: '<button class="jspsych-btn" style="width:150px; padding:10px; margin:5px;">%choice%</button>',
        data: {
            task: 'bcst_sort',
            target_image: jsPsych.timelineVariable('image'),
            target_color: jsPsych.timelineVariable('color'),
            target_shape: jsPsych.timelineVariable('shape'),
            target_number: jsPsych.timelineVariable('number')
        },
        on_finish: function(data) {
            var choiceIndex = data.response;
            var chosenCard = referenceCards[choiceIndex];

            // Matches
            var match_color = (data.target_color === chosenCard.color);
            var match_shape = (data.target_shape === chosenCard.shape);
            var match_number = (data.target_number === chosenCard.number);

            // Correctness
            var isCorrect = false;
            if (activeRule === 'color' && match_color) isCorrect = true;
            else if (activeRule === 'shape' && match_shape) isCorrect = true;
            else if (activeRule === 'number' && match_number) isCorrect = true;

            // Rule Switch Logic
            var ruleShift = false;
            if (isCorrect) {
                consecutiveCorrect++;
                if (consecutiveCorrect >= STREAK_THRESHOLD) {
                    consecutiveCorrect = 0;
                    currentRuleIndex++;
                    if (currentRuleIndex >= ruleSequence.length) currentRuleIndex = 0;
                    activeRule = ruleSequence[currentRuleIndex];
                    ruleShift = true;
                }
            } else {
                consecutiveCorrect = 0;
            }

            // Save Data
            data.correct = isCorrect;
            data.current_rule = activeRule; 
            data.match_color = match_color;
            data.match_shape = match_shape;
            data.match_number = match_number;
            data.rule_shift = ruleShift;
        }
    };

    // Feedback Trial
    var feedback_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var last_trial = jsPsych.data.get().last(1).values()[0];
            if (last_trial.correct) {
                return '<p style="color:green; font-size:40px; font-weight:bold;">Correct!</p>';
            } else {
                return '<p style="color:red; font-size:40px; font-weight:bold;">Incorrect</p>';
            }
        },
        choices: "NO_KEYS",
        trial_duration: BCST_CONFIG.feedback_duration
    };

    // Preload Trial (Optional but recommended)
    // Create list of all images: the 64 deck cards + the 4 reference cards + the instruction image
    var preload_images = deck.map(d => IMG_FOLDER + d.image);
    referenceCards.forEach(c => preload_images.push(IMG_FOLDER + c.img));
    preload_images.push(IMG_FOLDER + 'instruction.png');

    // --- 5. TIMELINE CONSTRUCTION ---
    var full_bcst_timeline = {
        timeline: [instructions, {
            timeline: [sort_trial, feedback_trial],
            timeline_variables: deck
        }]
    };

    return full_bcst_timeline;
}